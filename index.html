<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cartes de Révision</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #333;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 10px;
      text-align: center;
    }
    .container {
      padding: 20px;
    }
    .btn {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #3498db; color: white; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-add { background: #2ecc71; color: white; }
    .btn-export { background: #e67e22; color: white; }
    .btn-import { background: #9b59b6; color: white; }
    .levels button {
      display: block;
      width: 100%;
      margin: 8px 0;
    }
    .modal {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }
    .modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 18px;
      cursor: pointer;
    }
    .flashcard {
      width: 200px;
      height: 120px;
      perspective: 1000px;
      margin: 10px;
      display: inline-block;
      cursor: pointer;
    }
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    .flashcard .front, .flashcard .back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: white;
      overflow: hidden;
    }
    .flashcard .back {
      transform: rotateY(180deg);
    }
  </style>
</head>
<body>
  <header>
    <h1>Cartes de Révision</h1>
  </header>

  <div class="container">
    <!-- Choix des niveaux -->
    <div id="levelsSection">
      <h2>Choisis un niveau</h2>
      <div class="levels">
        <button class="btn btn-primary" onclick="openModal('Seconde')">Seconde</button>
        <button class="btn btn-primary" onclick="openModal('Première')">Première</button>
        <button class="btn btn-primary" onclick="openModal('Terminale')">Terminale</button>
        <button class="btn btn-primary" onclick="openModal('Maths expertes')">Maths expertes</button>
      </div>
      <button class="btn btn-add" onclick="toggleCreate()">Créer tes cartes</button>
      <button class="btn btn-secondary" id="reviseBtn">Réviser mes cartes</button>
    </div>

    <!-- Création des cartes -->
    <div id="createSection" style="display:none;" aria-hidden="true">
      <h2>Créer des cartes</h2>
      <label>Texte (recto)</label><br>
      <textarea id="frontText"></textarea><br>
      <input type="file" id="frontImg" accept="image/*"><br>
      <label>Texte (verso)</label><br>
      <textarea id="backText"></textarea><br>
      <input type="file" id="backImg" accept="image/*"><br>
      <button class="btn btn-add" id="addCardBtn">Ajouter la carte</button>
      <button class="btn btn-secondary" onclick="showLevels()">Retour</button>
      <button class="btn btn-export" onclick="exportDeck()">Exporter</button>
      <button class="btn btn-import" id="importBtn">Importer</button>
      <input type="file" id="importFile" accept=".json" style="display:none;">
      <h3>Mes cartes</h3>
      <div id="cardsList"></div>
    </div>
  </div>

  <!-- Modal chapitres -->
  <div id="chapterModal" class="modal" aria-hidden="true">
    <div class="card">
      <span class="close" onclick="closeModal()">✕</span>
      <h2 id="modalTitle"></h2>
      <ul id="chapterList"></ul>
      <button class="btn btn-primary" onclick="startRevision()">Commencer la révision</button>
    </div>
  </div>

  <!-- Script -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {

    const chapters = {
      "Seconde": ["Chapitre 1 : Bases", "Chapitre 2 : Fonctions", "Chapitre 3 : Géométrie"],
      "Première": ["Chapitre 1 : Suites", "Chapitre 2 : Probabilités", "Chapitre 3 : Analyse"],
      "Terminale": ["Chapitre 1 : Dérivées", "Chapitre 2 : Intégrales", "Chapitre 3 : Logarithmes"],
      "Maths expertes": ["Chapitre 1 : Nombres complexes", "Chapitre 2 : Graphes", "Chapitre 3 : Matrices"]
    };

    let currentLevel = null;
    let selectedChapter = null;
    let deck = [];

    /* -------- MODAL NIVEAUX -------- */
    function openModal(level) {
      currentLevel = level;
      selectedChapter = null;
      document.getElementById('modalTitle').textContent = level + " — Chapitres";

      const list = document.getElementById('chapterList');
      list.innerHTML = '';

      (chapters[level] || []).forEach(chap => {
        const li = document.createElement('li');
        li.textContent = chap;
        li.onclick = () => {
          Array.from(list.children).forEach(c => c.style.background = '');
          li.style.background = '#dfefff';
          selectedChapter = chap;
        };
        list.appendChild(li);
      });

      const modal = document.getElementById('chapterModal');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal() {
      const modal = document.getElementById('chapterModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      selectedChapter = null;
    }

    function startRevision() {
      if (!selectedChapter) {
        alert("Sélectionne un chapitre");
        return;
      }
      alert("Démarrage : " + currentLevel + " — " + selectedChapter);
      closeModal();
    }

    /* -------- CREATION -------- */
    function toggleCreate() {
      const create = document.getElementById('createSection');
      const levels = document.getElementById('levelsSection');
      if (create.style.display === 'block') {
        create.style.display = 'none';
        levels.style.display = '';
        create.setAttribute('aria-hidden','true');
      } else {
        create.style.display = 'block';
        levels.style.display = 'none';
        create.setAttribute('aria-hidden','false');
      }
    }

    function showLevels() {
      document.getElementById('createSection').style.display = 'none';
      document.getElementById('createSection').setAttribute('aria-hidden','true');
      document.getElementById('levelsSection').style.display = 'block';
    }

    /* -------- OUTILS -------- */
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('\n','<br>');
    }

    /* -------- AJOUT CARTES -------- */
    async function addCard() {
      const fTxt = document.getElementById('frontText').value.trim();
      const bTxt = document.getElementById('backText').value.trim();
      const fFile = document.getElementById('frontImg').files[0];
      const bFile = document.getElementById('backImg').files[0];

      let fImg="", bImg="";
      if (fFile) {
        fImg = await new Promise(r => {
          const fr = new FileReader();
          fr.onload = e => r(e.target.result);
          fr.readAsDataURL(fFile);
        });
      }
      if (bFile) {
        bImg = await new Promise(r => {
          const fr = new FileReader();
          fr.onload = e => r(e.target.result);
          fr.readAsDataURL(bFile);
        });
      }

      if (!fTxt && !bTxt && !fImg && !bImg) {
        alert("Ajoute du texte ou une image.");
        return;
      }

      deck.push({ front: fTxt, back: bTxt, frontImg: fImg, backImg: bImg });
      renderCardsPreview();

      document.getElementById('frontText').value = '';
      document.getElementById('backText').value = '';
      document.getElementById('frontImg').value = '';
      document.getElementById('backImg').value = '';
    }

    function renderCardsPreview() {
      const list = document.getElementById('cardsList');
      list.innerHTML = '';
      deck.forEach(c => {
        const div = document.createElement('div');
        div.className = 'flashcard';
        div.innerHTML = `
          <div class="flashcard-inner">
            <div class="front">
              ${c.frontImg ? `<img src="${c.frontImg}" style="max-width:90%;max-height:100px"><br>` : ''}
              ${escapeHtml(c.front||'')}
            </div>
            <div class="back">
              ${c.backImg ? `<img src="${c.backImg}" style="max-width:90%;max-height:100px"><br>` : ''}
              ${escapeHtml(c.back||'')}
            </div>
          </div>`;
        div.addEventListener('click', () => div.classList.toggle('flipped'));
        list.appendChild(div);
      });
    }

    /* -------- IMPORT / EXPORT -------- */
    function exportDeck() {
      if (deck.length === 0) {
        alert("Aucune carte");
        return;
      }
      const blob = new Blob([JSON.stringify(deck)], {type:"application/json"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "deck.json";
      a.click();
    }

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', evt => {
      const f = evt.target.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = e => {
        try {
          deck = JSON.parse(e.target.result);
          renderCardsPreview();
        } catch {
          alert("Fichier invalide");
        }
      };
      fr.readAsText(f);
    });

    /* -------- REVISION -------- */
    function shuffle(array) {
      for (let i=array.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    document.getElementById('reviseBtn').addEventListener('click', () => {
      if (deck.length === 0) {
        alert("Aucune carte à réviser !");
        return;
      }

      const shuffled = [...deck];
      shuffle(shuffled);

      let idx=0, correct=0, incorrect=0;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="card" style="max-width:500px;text-align:center;position:relative;">
          <div class="close" id="closeRevise">✕</div>
          <div id="reviseContent"></div>
          <div id="reviewInfo" style="margin-top:10px;">Carte 1/${shuffled.length} | ✔️ 0 | ❌ 0</div>
          <div id="reviewButtons" style="margin-top:12px;">
            <button id="correctBtn" class="btn btn-add">Correcte</button>
            <button id="incorrectBtn" class="btn btn-secondary">Incorrecte</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const container = modal.querySelector('#reviseContent');
      const infoDiv = modal.querySelector('#reviewInfo');

      function updateInfo() {
        infoDiv.textContent = `Carte ${idx+1}/${shuffled.length} | ✔️ ${correct} | ❌ ${incorrect}`;
      }

      function showCard(i) {
        const c = shuffled[i];
        container.innerHTML = `
          <div class="flashcard" style="width:300px;height:180px;margin:auto;">
            <div class="flashcard-inner">
              <div class="front">
                ${c.frontImg ? `<img src="${c.frontImg}" style="max-width:90%;max-height:100px"><br>` : ''}
                ${escapeHtml(c.front||'')}
              </div>
              <div class="back">
                ${c.backImg ? `<img src="${c.backImg}" style="max-width:90%;max-height:100px"><br>` : ''}
                ${escapeHtml(c.back||'')}
              </div>
            </div>
          </div>`;
        const flash = container.querySelector('.flashcard');
        flash.addEventListener('click', () => flash.classList.toggle('flipped'));
      }

      function nextCard() {
        updateInfo();
        idx++;
        if (idx >= shuffled.length) {
          endRevision();
        } else {
          showCard(idx);
        }
      }

      function endRevision() {
        updateInfo();

        const recapSection = document.createElement('div');
        recapSection.style.marginTop = '20px';
        recapSection.innerHTML = `<h3>Récapitulatif des réponses</h3>`;

        const list = document.createElement('ul');
        shuffled.forEach((c,i) => {
          const li = document.createElement('li');
          li.innerHTML = `${escapeHtml(c.front||'')} → ${escapeHtml(c.back||'')} : ${i<correct ? '✔️ Correcte' : '❌ Incorrecte'}`;
          list.appendChild(li);
        });
        recapSection.appendChild(list);

        const createSec = document.getElementById('createSection');
        createSec.appendChild(recapSection);
        createSec.style.display = 'block';
        document.getElementById('levelsSection').style.display = 'none';
        createSec.setAttribute('aria-hidden','false');

        if (correct === shuffled.length) {
          const confetti = document.createElement('div');
          confetti.style.position = 'fixed';
          confetti.style.top = 0;
          confetti.style.left = 0;
          confetti.style.width = '100%';
          confetti.style.height = '100%';
          confetti.style.pointerEvents = 'none';
          confetti.style.zIndex = 2000;
          document.body.appendChild(confetti);

          for (let i=0; i<150; i++) {
            const c = document.createElement('div');
            c.style.position = 'absolute';
            c.style.width = '10px';
            c.style.height = '10px';
            c.style.background = `hsl(${Math.random()*360},100%,50%)`;
            c.style.left = Math.random()*window.innerWidth+'px';
            c.style.top = Math.random()*window.innerHeight+'px';
            c.style.opacity = 1;
            c.style.transform = `rotate(${Math.random()*360}deg)`;
            c.style.borderRadius = '50%';
            c.style.transition = 'transform 3s ease, top 3s ease, opacity 3s ease';
            confetti.appendChild(c);
            setTimeout(() => {
              c.style.top = window.innerHeight+'px';
              c.style.opacity = 0;
              c.style.transform = `rotate(${Math.random()*720}deg)`;
            },10);
          }
          setTimeout(() => { document.body.removeChild(confetti); },3000);
          alert("Félicitations ! Toutes les cartes sont correctes 🎉");
        } else {
          alert("Révision terminée !");
        }

        document.body.removeChild(modal);
      }

      // initialisation
      showCard(idx);
      updateInfo();

      modal.querySelector('#correctBtn').onclick = () => { correct++; nextCard(); };
      modal.querySelector('#incorrectBtn').onclick = () => { incorrect++; nextCard(); };
      modal.querySelector('#closeRevise').onclick = () => { document.body.removeChild(modal); };

    });

    /* -------- BOUTONS -------- */
    document.getElementById('addCardBtn').addEventListener('click', addCard);
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.startRevision = startRevision;
    window.toggleCreate = toggleCreate;
    window.showLevels = showLevels;
    window.exportDeck = exportDeck;

  });
  </script>
</body>
</html>
